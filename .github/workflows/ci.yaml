name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

jobs:
  test-lint-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install tools
        run: |
          go install golang.org/x/tools/gopls@latest
          go install golang.org/x/tools/cmd/goimports@latest

      - name: gofmt check
        run: |
          test -z "$(gofmt -l .)" || (echo "gofmt needed; run: gofmt -w ." && exit 1)

      - name: goimports check (optional but recommended)
        run: |
          test -z "$(goimports -l .)" || (echo "goimports needed; run: goimports -w ." && exit 1)

      - name: go mod tidy check
        run: |
          go mod tidy
          git diff --exit-code

      - name: gopls check (lint)
        run: |
          gopls check cmd/thermocktat/main.go cmd/app/config.go internal/thermostat/*.go internal/controllers/http/*.go

      - name: go vet
        run: |
          go vet ./...

      - name: Build
        run: |
          mkdir -p .bin
          go build -o .bin/thermocktat ./cmd/thermocktat/main.go

      - name: Run tests (with coverage)
        run: |
          go test -race -coverprofile=coverage.txt -covermode=atomic ./...

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload Binary for Integration Tests
        uses: actions/upload-artifact@v4
        with:
          name: thermocktat-binary
          path: .bin/thermocktat
          retention-days: 1

  integration-tests:
      needs: test-lint-build
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Install uv
          uses: astral-sh/setup-uv@v5

        - name: Set up Python
          run: uv python install

        - name: Lint and Type Check (Python)
          run: |
            cd integration
            uv sync
            uv run ruff check .
            uv run ruff format --check .
            uv run ty check

        - name: Write mosquitto config (allow anonymous)
          run: |
            cat > /tmp/mosquitto.conf <<'EOF'
            listener 1883 0.0.0.0
            allow_anonymous true
            persistence false
            EOF

        - name: Start Mosquitto Broker
          run: |
            docker run -d --name mosquitto \
              -p 1883:1883 \
              -v /tmp/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro \
              eclipse-mosquitto:2.0

        - name: Download Binary
          uses: actions/download-artifact@v4
          with:
            name: thermocktat-binary
            path: integration/.bin/

        - name: Fix permissions
          run: chmod +x integration/.bin/thermocktat

        - name: Run pytest
          run: |
            cd integration
            uv run pytest